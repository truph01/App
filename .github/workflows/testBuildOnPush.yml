name: Build and deploy apps for testing on push

on:
  push:
    branches: [main]
    paths-ignore: ['docs/**', 'contributingGuides/**', 'help/**', '.github/**', 'scripts/**', 'tests/**', 'jest/**', '.claude/**']

jobs:
  queue:
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 120
    steps:
      - name: Checkout
        # v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Wait for earlier runs to finish (FIFO queue)
        uses: ./.github/actions/javascript/waitForPreviousRuns
        with:
          GITHUB_TOKEN: ${{ github.token }}
          WORKFLOW_ID: testBuildOnPush.yml
          CURRENT_RUN_ID: ${{ github.run_id }}

  prep:
    needs: [queue]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    outputs:
      APP_REF: ${{ github.sha }}
      APP_PR_NUMBER: ${{ steps.getMergedPullRequest.outputs.PR_NUMBER }}
      BUILD_WEB: ${{ steps.detectOSBotifyPush.outputs.BUILD_WEB || 'true' }}
      BUILD_MOBILE: ${{ steps.detectOSBotifyPush.outputs.BUILD_MOBILE || 'true' }}
    steps:
      - name: Checkout
        # v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Validate that user is an Expensify employee
        uses: ./.github/actions/composite/validateActor
        with:
          REQUIRE_APP_DEPLOYER: false
          OS_BOTIFY_TOKEN: ${{ secrets.OS_BOTIFY_COMMIT_TOKEN }}

      - name: Detect OSBotify automated push
        id: detectOSBotifyPush
        if: ${{ github.actor == 'OSBotify' }}
        # v8
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          github-token: ${{ github.token }}
          script: |
            const commitMessage = context.payload?.head_commit?.message || '';
            if (commitMessage.startsWith('Update Mobile-Expensify submodule')) {
              core.notice(`${context.actor} automated push with Mobile-Expensify submodule update detected. Skipping web build and post comments. No PR associated with this commit.`);
              core.setOutput('BUILD_WEB', 'false');
            } else {
              core.warning(`OSBotify automated push detected but without Mobile-Expensify submodule update commit phrase. Skipping rest of the workflow. No PR associated with this commit.`);
              core.setOutput('BUILD_MOBILE', 'false');
              core.setOutput('BUILD_WEB', 'false');
            }

      - name: Get merged pull request
        id: getMergedPullRequest
        if: ${{ github.actor != 'OSBotify' }}
        # v8
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
            github-token: ${{ github.token }}
            script: |
                const prData = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: context.sha,
                });
                const prNumber = prData?.data?.find(p => p.state === 'closed' && p.merged_at)?.number?.toString();
                if (prNumber) {
                  const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${prNumber}`;
                  core.notice(`Found merged pull request: [#${prNumber}](${prUrl})`);
                  core.setOutput('PR_NUMBER', prNumber);
                } else {
                  core.setFailed(`Commit pushed by non-OSBotify actor. No merged pull request found for commit ${context.sha}`);
                }

  postGitHubCommentBuildStarted:
    name: Post build started comment
    if: ${{ needs.prep.outputs.APP_PR_NUMBER != '' }}
    needs: [prep]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Add build start comment to Expensify/App PR
        # v8
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          github-token: ${{ github.token }}
          script: |
            const workflowURL = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.prep.outputs.APP_PR_NUMBER }},
              body: `üöß @${{ github.actor }} has triggered a test Expensify/App build. You can view the [workflow run here](${workflowURL}).`
            });

  buildAndroid:
    name: Build Android
    needs: [prep]
    if: ${{ fromJSON(needs.prep.outputs.BUILD_MOBILE) }}
    uses: ./.github/workflows/buildAndroid.yml
    with:
      ref: ${{ needs.prep.outputs.APP_REF }}
      variant: Adhoc
      pull-request-number: ${{ needs.prep.outputs.APP_PR_NUMBER }}
    secrets: inherit

  buildIOS:
    name: Build iOS
    needs: [prep]
    if: ${{ fromJSON(needs.prep.outputs.BUILD_MOBILE) }}
    uses: ./.github/workflows/buildIOS.yml
    with:
      ref: ${{ needs.prep.outputs.APP_REF }}
      variant: Adhoc
      pull-request-number: ${{ needs.prep.outputs.APP_PR_NUMBER }}
    secrets: inherit

  buildWeb:
    name: Build Web
    needs: [prep]
    if: ${{ fromJSON(needs.prep.outputs.BUILD_WEB) && needs.prep.outputs.APP_PR_NUMBER != '' }}
    uses: ./.github/workflows/buildWeb.yml
    with:
      ref: ${{ needs.prep.outputs.APP_REF }}
      environment: adhoc
      pull-request-number: ${{ needs.prep.outputs.APP_PR_NUMBER }}
      upload-artifacts: false
      deploy-to-s3: true
      build-storybook: false
    secrets: inherit

  postGithubComment:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: ${{ always() && needs.prep.outputs.APP_PR_NUMBER != '' }}
    name: Post a GitHub comment with app download links for testing
    needs: [prep, buildWeb, buildAndroid, buildIOS]
    steps:
      - name: Checkout
        # v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          ref: ${{ needs.prep.outputs.APP_REF }}

      - name: Download Artifact
        # v7
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131

      - name: Publish links to apps for download on Expensify/App PR
        if: ${{ needs.prep.outputs.APP_PR_NUMBER != '' }}
        uses: ./.github/actions/javascript/postTestBuildComment
        with:
          REPO: App
          APP_PR_NUMBER: ${{ needs.prep.outputs.APP_PR_NUMBER }}
          GITHUB_TOKEN: ${{ github.token }}
          ANDROID: ${{ needs.buildAndroid.result }}
          IOS: ${{ needs.buildIOS.result }}
          WEB: ${{ needs.buildWeb.result }}
          ANDROID_LINK: ${{ needs.buildAndroid.outputs.ROCK_ARTIFACT_URL }}
          IOS_LINK: ${{ needs.buildIOS.outputs.ROCK_ARTIFACT_URL }}
          WEB_LINK: https://${{ needs.prep.outputs.APP_PR_NUMBER }}.pr-testing.expensify.com

  buildSummary:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: ${{ always() && (needs.prep.outputs.APP_PR_NUMBER != '' || needs.buildAndroid.outputs.ROCK_ARTIFACT_URL != '' || needs.buildIOS.outputs.ROCK_ARTIFACT_URL != '') }}
    name: Build Summary
    needs: [prep, buildWeb, buildAndroid, buildIOS]
    steps:
      - name: Checkout
        # v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          ref: ${{ needs.prep.outputs.APP_REF }}

      - name: Create build summary
        # v8
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = '${{ needs.prep.outputs.APP_PR_NUMBER }}';
            const webLink = prNumber && '${{ needs.buildWeb.result }}' === 'success' ? `https://${prNumber}.pr-testing.expensify.com` : '';
            const androidLink = '${{ needs.buildAndroid.outputs.ROCK_ARTIFACT_URL }}' || '';
            const iosLink = '${{ needs.buildIOS.outputs.ROCK_ARTIFACT_URL }}' || '';

            const webStatus = webLink ? '‚úÖ Success' : '${{ needs.buildWeb.result }}' === 'failure' ? '‚ùå Failed' : '‚è≠Ô∏è Skipped';
            const androidStatus = androidLink ? '‚úÖ Success' : '${{ needs.buildAndroid.result }}' === 'failure' ? '‚ùå Failed' : '‚è≠Ô∏è Skipped';
            const iosStatus = iosLink ? '‚úÖ Success' : '${{ needs.buildIOS.result }}' === 'failure' ? '‚ùå Failed' : '‚è≠Ô∏è Skipped';

            const summary = core.summary
              .addTable([
                [{data: 'Platform', header: true}, {data: 'Status', header: true}, {data: 'Download', header: true}],
                [
                  'Web',
                  webStatus,
                  webLink ? `<a href="${webLink}">${webLink}</a>` : '-'
                ],
                [
                  'Android',
                  androidStatus,
                  androidLink ? `<a href="${androidLink}">${androidLink}</a>` : '-'
                ],
                [
                  'iOS',
                  iosStatus,
                  iosLink ? `<a href="${iosLink}">${iosLink}</a>` : '-'
                ],
              ]);

            if (prNumber) {
              const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${prNumber}`;
              summary.addRaw(`\n**PR Link:** ${prUrl}`);
            } else {
              summary.addRaw(`\n**PR Link:** No PR associated with this commit.`);
            }

            summary.write();
