name: Build and deploy apps for testing

on:
  workflow_dispatch:
    inputs:
      # If not specified, only build iOS and Android apps from the main branch of Expensify/App
      APP_PULL_REQUEST_URL:
        description: The Expensify/App pull request URL (e.g., https://github.com/Expensify/App/pull/12345). Defaults to main.
        required: false
        default: ''
      # Pull Request URL from Mobile-Expensify repo for correct placement of OD app. It will take precedence over MOBILE-EXPENSIFY from App's PR description if both are specified. If nothing is specified defaults to Mobile-Expensify's main
      MOBILE_EXPENSIFY_PULL_REQUEST_URL:
        description: The Expensify/Mobile-Expensify pull request URL. Defaults to main. Overrides MOBILE-EXPENSIFY set in App's PR description.
        required: false
        default: ''
      REVIEWED_CODE:
        description: I reviewed this pull request and verified that it does not contain any malicious code.
        type: boolean
        required: true
        default: false
      WEB:
        description: Should build web app?
        type: boolean
        default: true
      IOS:
        description: Should build iOS app?
        type: boolean
        default: true
      ANDROID:
        description: Should build android app?
        type: boolean
        default: true

jobs:
  prep:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    outputs:
      APP_REF: ${{ steps.getHeadRef.outputs.REF || 'main' }}
      APP_PR_NUMBER: ${{ steps.extractAppPRNumber.outputs.PR_NUMBER }}
      MOBILE_PR_NUMBER: ${{ steps.extractMobilePRNumber.outputs.PR_NUMBER }}
    steps:
      - name: Checkout
        # v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Validate that user is an Expensify employee
        uses: ./.github/actions/composite/validateActor
        with:
          REQUIRE_APP_DEPLOYER: false
          OS_BOTIFY_TOKEN: ${{ secrets.OS_BOTIFY_COMMIT_TOKEN }}

      - name: Validate that the user reviewed the pull request before running a test build
        if: ${{ !inputs.REVIEWED_CODE }}
        run: |
          echo "::error::üïµÔ∏è‚Äç‚ôÄÔ∏è Please carefully review the pull request before running a test build to ensure it does not contain any malicious code"
          exit 1

      - name: Extract App PR number from URL
        id: extractAppPRNumber
        if: ${{ inputs.APP_PULL_REQUEST_URL != '' }}
        run: |
          PR_NUMBER=$(echo '${{ inputs.APP_PULL_REQUEST_URL }}' | sed -E 's|.*/pull/([0-9]+).*|\1|')
          if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "::error::‚ùå Could not extract PR number from URL. Please provide a valid GitHub PR URL (e.g., https://github.com/Expensify/App/pull/12345)"
            exit 1
          fi
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Extract Mobile-Expensify PR number from URL
        id: extractMobilePRNumber
        if: ${{ inputs.MOBILE_EXPENSIFY_PULL_REQUEST_URL != '' }}
        run: |
          PR_NUMBER=$(echo '${{ inputs.MOBILE_EXPENSIFY_PULL_REQUEST_URL }}' | sed -E 's|.*/pull/([0-9]+).*|\1|')
          if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "::error::‚ùå Could not extract PR number from URL. Please provide a valid GitHub PR URL (e.g., https://github.com/Expensify/Mobile-Expensify/pull/12345)"
            exit 1
          fi
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Check if App pull request number is correct
        id: getHeadRef
        run: |
          set -e
          if [ -z "${{ steps.extractAppPRNumber.outputs.PR_NUMBER }}" ]; then
            echo "REF=" >> "$GITHUB_OUTPUT"
          else
            echo "REF=$(gh pr view ${{ steps.extractAppPRNumber.outputs.PR_NUMBER }} --json headRefOid --jq '.headRefOid')" >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}

  getMobileExpensifyPR:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [prep]
    outputs:
      MOBILE_EXPENSIFY_PR: ${{ steps.mobileExpensifyPR.outputs.result }}
    steps:
      - name: Check if author specified Expensify/Mobile-Expensify PR
        id: mobileExpensifyPR
        # v8
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          github-token: ${{ github.token }}
          result-encoding: string
          script: |
            if ('${{ needs.prep.outputs.MOBILE_PR_NUMBER }}') {
              return '${{ needs.prep.outputs.MOBILE_PR_NUMBER }}';
            }

            if (!'${{ needs.prep.outputs.APP_PR_NUMBER }}') {
              return '';
            }

            const pullRequest = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: '${{ needs.prep.outputs.APP_PR_NUMBER }}',
            });
            
            const body = pullRequest.data.body;
            const regex = /MOBILE-EXPENSIFY:\s*https:\/\/github.com\/Expensify\/Mobile-Expensify\/pull\/(?<prNumber>\d+)/;
            const found = body.match(regex)?.groups?.prNumber || "";

            return found.trim();

  getMobileExpensifyRef:
      runs-on: blacksmith-4vcpu-ubuntu-2404
      needs: [prep, getMobileExpensifyPR]
      outputs:
        MOBILE_EXPENSIFY_REF: ${{ steps.getHeadRef.outputs.REF || 'main' }}
      steps:
        - name: Checkout
          # v6
          uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

        - name: Check if Expensify/Mobile-Expensify pull request number is correct
          id: getHeadRef
          run: |
            set -e
            if [[ -z "${{ needs.prep.outputs.MOBILE_PR_NUMBER }}" && -z "${{ needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR }}" ]]; then
              echo "REF=" >> "$GITHUB_OUTPUT"
            else
              echo "PR=${{ needs.prep.outputs.MOBILE_PR_NUMBER || needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR }}" >> "$GITHUB_OUTPUT"
              echo "REF=$(gh pr view ${{ needs.prep.outputs.MOBILE_PR_NUMBER || needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR }} -R Expensify/Mobile-Expensify --json headRefOid --jq '.headRefOid')" >> "$GITHUB_OUTPUT"
            fi
          env:
            GITHUB_TOKEN: ${{ secrets.OS_BOTIFY_TOKEN }}

  postGitHubCommentBuildStarted:
    name: Post build started comment
    if: ${{ needs.prep.outputs.APP_PR_NUMBER != '' || needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR != '' }}
    needs: [prep, getMobileExpensifyPR]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Add build start comment to Expensify/App PR
        if: ${{ needs.prep.outputs.APP_PR_NUMBER != '' }}
        # v8
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          github-token: ${{ github.token }}
          script: |
            const workflowURL = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.prep.outputs.APP_PR_NUMBER }},
              body: `üöß @${{ github.actor }} has triggered a test Expensify/App build. You can view the [workflow run here](${workflowURL}).`
            });

      - name: Add build start comment to Expensify/Mobile-Expensify PR
        if: ${{ needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR != '' }}
        # v8
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          github-token: ${{ secrets.OS_BOTIFY_TOKEN }}
          script: |
            const workflowURL = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: 'Mobile-Expensify',
              issue_number: ${{ needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR }},
              body: `üöß @${{ github.actor }} has triggered a test Expensify/Mobile-Expensify build. You can view the [workflow run here](${workflowURL}).`
            });

  buildAndroid:
    name: Build Android
    needs: [prep, getMobileExpensifyPR, getMobileExpensifyRef]
    if: ${{ inputs.ANDROID }}
    uses: ./.github/workflows/buildAndroid.yml
    with:
      ref: ${{ needs.prep.outputs.APP_REF }}
      variant: Adhoc
      mobile-expensify-ref: ${{ needs.getMobileExpensifyRef.outputs.MOBILE_EXPENSIFY_REF }}
      pull-request-number: ${{ needs.prep.outputs.APP_PR_NUMBER }}
    secrets: inherit

  buildIOS:
    name: Build iOS
    needs: [prep, getMobileExpensifyPR, getMobileExpensifyRef]
    if: ${{ inputs.IOS }}
    uses: ./.github/workflows/buildIOS.yml
    with:
      ref: ${{ needs.prep.outputs.APP_REF }}
      variant: Adhoc
      mobile-expensify-ref: ${{ needs.getMobileExpensifyRef.outputs.MOBILE_EXPENSIFY_REF }}
      pull-request-number: ${{ needs.prep.outputs.APP_PR_NUMBER }}
    secrets: inherit

  buildWeb:
    name: Build Web
    needs: [prep, getMobileExpensifyPR, getMobileExpensifyRef]
    if: ${{ inputs.WEB && needs.prep.outputs.APP_PR_NUMBER != '' }}
    uses: ./.github/workflows/buildWeb.yml
    with:
      ref: ${{ needs.prep.outputs.APP_REF }}
      environment: adhoc
      pull-request-number: ${{ needs.prep.outputs.APP_PR_NUMBER }}
      upload-artifacts: false
      deploy-to-s3: true
      build-storybook: false
    secrets: inherit

  postGithubComment:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: ${{ always() && (needs.prep.outputs.APP_PR_NUMBER != '' || needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR != '') }}
    name: Post a GitHub comment with app download links for testing
    needs: [prep, getMobileExpensifyPR, getMobileExpensifyRef, buildWeb, buildAndroid, buildIOS]
    steps:
      - name: Checkout
        # v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          ref: ${{ needs.prep.outputs.APP_REF }}

      - name: Download Artifact
        # v7
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131

      - name: Publish links to apps for download on Expensify/App PR
        if: ${{ needs.prep.outputs.APP_PR_NUMBER != '' }}
        uses: ./.github/actions/javascript/postTestBuildComment
        with:
          REPO: App
          APP_PR_NUMBER: ${{ needs.prep.outputs.APP_PR_NUMBER }}
          MOBILE_EXPENSIFY_PR_NUMBER: ${{ needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR }}
          GITHUB_TOKEN: ${{ github.token }}
          ANDROID: ${{ needs.buildAndroid.result }}
          IOS: ${{ needs.buildIOS.result }}
          WEB: ${{ needs.buildWeb.result }}
          ANDROID_LINK: ${{ needs.buildAndroid.outputs.ROCK_ARTIFACT_URL }}
          IOS_LINK: ${{ needs.buildIOS.outputs.ROCK_ARTIFACT_URL }}
          WEB_LINK: https://${{ needs.prep.outputs.APP_PR_NUMBER }}.pr-testing.expensify.com

      - name: Publish links to apps for download on Expensify/Mobile-Expensify PR
        if: ${{ needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR != '' }}
        uses: ./.github/actions/javascript/postTestBuildComment
        with:
          REPO: Mobile-Expensify
          MOBILE_EXPENSIFY_PR_NUMBER: ${{ needs.getMobileExpensifyPR.outputs.MOBILE_EXPENSIFY_PR }}
          GITHUB_TOKEN: ${{ secrets.OS_BOTIFY_TOKEN }}
          ANDROID: ${{ needs.buildAndroid.result }}
          IOS: ${{ needs.buildIOS.result }}
          ANDROID_LINK: ${{ needs.buildAndroid.outputs.ROCK_ARTIFACT_URL }}
          IOS_LINK: ${{ needs.buildIOS.outputs.ROCK_ARTIFACT_URL }}

  buildSummary:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: ${{ always() && (needs.prep.outputs.APP_PR_NUMBER != '' || needs.buildAndroid.outputs.ROCK_ARTIFACT_URL != '' || needs.buildIOS.outputs.ROCK_ARTIFACT_URL != '') }}
    name: Build Summary
    needs: [prep, getMobileExpensifyPR, getMobileExpensifyRef, buildWeb, buildAndroid, buildIOS]
    steps:
      - name: Checkout
        # v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          ref: ${{ needs.prep.outputs.APP_REF }}

      - name: Get Mobile-Expensify ref
        id: getMobileExpensifySHA
        run: |
          if [ -n "${{ needs.getMobileExpensifyRef.outputs.MOBILE_EXPENSIFY_REF }}" ]; then
            echo "SHA=${{ needs.getMobileExpensifyRef.outputs.MOBILE_EXPENSIFY_REF }}" >> "$GITHUB_OUTPUT"
          elif [ -d "Mobile-Expensify" ]; then
            SUBMODULE_SHA=$(git ls-tree HEAD Mobile-Expensify | awk '{print $3}')
            echo "SHA=$SUBMODULE_SHA" >> "$GITHUB_OUTPUT"
          fi

      - name: Create build summary
        # v8
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = '${{ needs.prep.outputs.APP_PR_NUMBER }}';
            const webLink = prNumber && '${{ needs.buildWeb.result }}' === 'success' ? `https://${prNumber}.pr-testing.expensify.com` : '';
            const androidLink = '${{ needs.buildAndroid.outputs.ROCK_ARTIFACT_URL }}' || '';
            const iosLink = '${{ needs.buildIOS.outputs.ROCK_ARTIFACT_URL }}' || '';
            const mobileExpensifySHA = '${{ steps.getMobileExpensifySHA.outputs.SHA }}' || '';

            const webStatus = webLink ? '‚úÖ Success' : '${{ needs.buildWeb.result }}' === 'failure' ? '‚ùå Failed' : '‚è≠Ô∏è Skipped';
            const androidStatus = androidLink ? '‚úÖ Success' : '${{ needs.buildAndroid.result }}' === 'failure' ? '‚ùå Failed' : '‚è≠Ô∏è Skipped';
            const iosStatus = iosLink ? '‚úÖ Success' : '${{ needs.buildIOS.result }}' === 'failure' ? '‚ùå Failed' : '‚è≠Ô∏è Skipped';

            const summary = core.summary
              .addTable([
                [{data: 'Platform', header: true}, {data: 'Status', header: true}, {data: 'Download', header: true}],
                [
                  'Web',
                  webStatus,
                  webLink ? `<a href="${webLink}">${webLink}</a>` : '-'
                ],
                [
                  'Android',
                  androidStatus,
                  androidLink ? `<a href="${androidLink}">${androidLink}</a>` : '-'
                ],
                [
                  'iOS',
                  iosStatus,
                  iosLink ? `<a href="${iosLink}">${iosLink}</a>` : '-'
                ],
              ]);

            if (mobileExpensifySHA) {
              const mobileExpensifyUrl = `https://github.com/Expensify/Mobile-Expensify/commit/${mobileExpensifySHA}`;
              const label = '${{ needs.getMobileExpensifyRef.outputs.MOBILE_EXPENSIFY_REF }}' ? 'Mobile-Expensify SHA (Custom)' : 'Mobile-Expensify Submodule SHA';
              summary.addRaw(`\n**${label}:** [${mobileExpensifySHA}](${mobileExpensifyUrl})`);
            }

            if (prNumber) {
              const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${prNumber}`;
              summary.addRaw(`\n**PR Link:** ${prUrl}`);
            } else {
              summary.addRaw(`\n**PR Link:** No PR associated with this commit.`);
            }

            summary.write();
