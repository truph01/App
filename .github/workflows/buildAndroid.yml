name: Build Android HybridApp

on:
  workflow_call:
    inputs:
      ref:
        description: Git ref to checkout and build
        type: string
        required: true
      variant:
        description: "'Release' or 'Adhoc'"
        type: string
        required: true
      mobile-expensify-ref:
        description: Mobile-Expensify ref to checkout (empty to use submodule at HEAD)
        type: string
        default: ''
      pull-request-number:
        description: Pull request number associated with this build
        type: string
        default: ''
      artifact-prefix:
        description: Prefix for build artifact names
        type: string
        default: ''
      upload-sourcemaps:
        description: Whether to upload sourcemap artifacts
        type: boolean
        default: true

    outputs:
      VERSION_CODE:
        description: Android version code from the build
        value: ${{ jobs.build.outputs.VERSION_CODE }}
      ROCK_ARTIFACT_URL:
        description: URL to download the ad-hoc build artifact (adhoc only)
        value: ${{ jobs.build.outputs.ROCK_ARTIFACT_URL }}

jobs:
  build:
    name: Build Android HybridApp
    runs-on: blacksmith-32vcpu-ubuntu-2404
    env:
      PULL_REQUEST_NUMBER: ${{ inputs.pull-request-number }}
    outputs:
      VERSION_CODE: ${{ steps.getAndroidVersion.outputs.VERSION_CODE }}
      ROCK_ARTIFACT_URL: ${{ steps.set-artifact-url.outputs.ARTIFACT_URL }}
    steps:
      - name: Checkout
        # v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          submodules: true
          ref: ${{ inputs.ref }}
          token: ${{ secrets.OS_BOTIFY_TOKEN }}

      - name: Checkout Mobile-Expensify to specified branch or commit
        if: ${{ inputs.mobile-expensify-ref != '' }}
        run: |
          cd Mobile-Expensify
          git fetch origin ${{ inputs.mobile-expensify-ref }}
          git checkout ${{ inputs.mobile-expensify-ref }}

      - name: Configure MapBox SDK
        run: ./scripts/setup-mapbox-sdk.sh ${{ secrets.MAPBOX_SDK_DOWNLOAD_TOKEN }}

      - name: Setup Node
        id: setup-node
        uses: ./.github/actions/composite/setupNode
        with:
          IS_HYBRID_BUILD: 'true'

      - name: Run grunt build
        run: |
          cd Mobile-Expensify
          npm run grunt:build:shared

      - name: Create .env.adhoc file based on staging
        if: ${{ inputs.variant == 'Adhoc' }}
        run: |
          cp .env.staging .env.adhoc
          sed -i 's/ENVIRONMENT=staging/ENVIRONMENT=adhoc/' .env.adhoc

      - name: Inject CI data into JS bundle
        if: ${{ inputs.variant == 'Adhoc' && inputs.pull-request-number != '' }}
        run: ./.github/scripts/inject-ci-data.sh PULL_REQUEST_NUMBER="$PULL_REQUEST_NUMBER"

      - name: Get Java version
        id: get-java-version
        uses: ./.github/actions/composite/getJavaVersion

      - name: Setup Java
        # v4
        uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12
        with:
          distribution: oracle
          java-version: ${{ steps.get-java-version.outputs.version }}

      - name: Setup Gradle
        # v4
        uses: gradle/actions/setup-gradle@06832c7b30a0129d7fb559bcc6e43d26f6374244

      - name: Setup 1Password CLI and certificates
        uses: Expensify/GitHub-Actions/setup-certificate-1p@main
        with:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          SHOULD_LOAD_SSL_CERTIFICATES: 'false'

      - name: Load files from 1Password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          op read "op://${{ vars.OP_VAULT }}/firebase.json/firebase.json" --force --out-file ./firebase.json
          op read "op://${{ vars.OP_VAULT }}/upload-key.keystore/upload-key.keystore" --force --out-file ./upload-key.keystore
          op read "op://${{ vars.OP_VAULT }}/android-fastlane-json-key.json/android-fastlane-json-key.json" --force --out-file ./android-fastlane-json-key.json
          cp ./upload-key.keystore Mobile-Expensify/Android

      - name: Load Android upload keystore credentials from 1Password
        id: load-credentials
        # v3
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb
        with:
          export-env: false
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          ANDROID_UPLOAD_KEYSTORE_PASSWORD: op://${{ vars.OP_VAULT }}/Repository-Secrets/ANDROID_UPLOAD_KEYSTORE_PASSWORD
          ANDROID_UPLOAD_KEYSTORE_ALIAS: op://${{ vars.OP_VAULT }}/Repository-Secrets/ANDROID_UPLOAD_KEYSTORE_ALIAS
          ANDROID_UPLOAD_KEY_PASSWORD: op://${{ vars.OP_VAULT }}/Repository-Secrets/ANDROID_UPLOAD_KEY_PASSWORD

      - name: Get Android native version
        id: getAndroidVersion
        run: echo "VERSION_CODE=$(grep -oP 'android:versionCode="\K[0-9]+' Mobile-Expensify/Android/AndroidManifest.xml)" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials
        # v6
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Rock Remote Build - Android
        id: rock-remote-build-android
        continue-on-error: true
        uses: callstackincubator/android@4cedf4d9b5c167452c96fe67233577e0fde9a025
        env:
          GITHUB_TOKEN: ${{ github.token }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          IS_HYBRID_APP: true
        with:
          variant: ${{ inputs.variant }}
          sign: true
          re-sign: true
          ad-hoc: ${{ inputs.variant == 'Adhoc' }}
          keystore-file: './upload-key.keystore'
          keystore-store-file: 'upload-key.keystore'
          keystore-store-password: ${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEYSTORE_PASSWORD }}
          keystore-key-alias: ${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEYSTORE_ALIAS }}
          keystore-key-password: ${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEY_PASSWORD }}
          keystore-path: '../tools/buildtools/upload-key.keystore'
          comment-bot: false
          rock-build-extra-params: ${{ inputs.variant == 'Adhoc' && '--extra-params "-PreactNativeArchitectures=arm64-v8a,x86_64 --profile"' || '--extra-params "--profile"' }}
          validate-elf-alignment: false

      - name: Clear Gradle cache
        if: steps.rock-remote-build-android.outcome == 'failure'
        run: |
          echo "::warning::Android build failed, clearing Gradle caches and retryingâ€¦"
          rm -rf ~/.gradle/caches

      - name: Rock Remote Build - Android (retry)
        if: steps.rock-remote-build-android.outcome == 'failure'
        uses: callstackincubator/android@4cedf4d9b5c167452c96fe67233577e0fde9a025
        env:
          GITHUB_TOKEN: ${{ github.token }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          IS_HYBRID_APP: true
        with:
          variant: ${{ inputs.variant }}
          sign: true
          re-sign: true
          ad-hoc: ${{ inputs.variant == 'Adhoc' }}
          keystore-file: './upload-key.keystore'
          keystore-store-file: 'upload-key.keystore'
          keystore-store-password: ${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEYSTORE_PASSWORD }}
          keystore-key-alias: ${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEYSTORE_ALIAS }}
          keystore-key-password: ${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEY_PASSWORD }}
          keystore-path: '../tools/buildtools/upload-key.keystore'
          comment-bot: false
          rock-build-extra-params: ${{ inputs.variant == 'Adhoc' && '--extra-params "-PreactNativeArchitectures=arm64-v8a,x86_64 --profile"' || '--extra-params "--profile"' }}
          validate-elf-alignment: false

      - name: Upload Gradle profile report
        if: always()
        # v6
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: ${{ inputs.artifact-prefix }}gradle-profile-report
          path: Mobile-Expensify/Android/build/reports/profile/
          if-no-files-found: ignore

      - name: Set artifact URL output
        id: set-artifact-url
        if: ${{ inputs.variant == 'Adhoc' }}
        run: echo "ARTIFACT_URL=$ARTIFACT_URL" >> "$GITHUB_OUTPUT"

      - name: Find and upload AAB artifact
        # v6
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: ${{ inputs.artifact-prefix }}androidBuild-artifact
          path: Mobile-Expensify/Android/app/build/outputs/bundle/release/*.aab

      - name: Upload Android sourcemap artifact
        if: ${{ inputs.upload-sourcemaps }}
        # v6
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: ${{ inputs.artifact-prefix }}android-sourcemap-artifact
          path: Mobile-Expensify/Android/build/generated/sourcemaps/react/release/index.android.bundle.map

      - name: Install bundletool
        run: |
          readonly BUNDLETOOL_VERSION="1.18.1"
          readonly BUNDLETOOL_URL="https://github.com/google/bundletool/releases/download/${BUNDLETOOL_VERSION}/bundletool-all-${BUNDLETOOL_VERSION}.jar"
          curl -L -o bundletool.jar "$BUNDLETOOL_URL"
          readonly EXPECTED_SHA="675786493983787ffa11550bdb7c0715679a44e1643f3ff980a529e9c822595c"
          SHA="$(sha256sum bundletool.jar | cut -d ' ' -f1)"
          if [[ "$SHA" != "$EXPECTED_SHA" ]]; then
            echo "SHA mismatch: expected $EXPECTED_SHA but got $SHA"
            exit 1
          fi

      - name: Generate APK from AAB
        run: |
          AAB_PATH=$(find Mobile-Expensify/Android/app/build/outputs/bundle -name '*.aab' | head -1)
          java -jar bundletool.jar build-apks --bundle="$AAB_PATH" --output=Expensify.apks \
            --mode=universal \
            --ks=upload-key.keystore \
            --ks-pass=pass:${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEYSTORE_PASSWORD }} \
            --ks-key-alias=${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEYSTORE_ALIAS }} \
            --key-pass=pass:${{ steps.load-credentials.outputs.ANDROID_UPLOAD_KEY_PASSWORD }}
          unzip -p Expensify.apks universal.apk > Expensify.apk

      - name: Upload Android APK build artifact
        # v6
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: ${{ inputs.artifact-prefix }}android-apk-artifact
          path: Expensify.apk
